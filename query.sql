SELECT resources.id, resources.name, SUM(production.batches.stages.machines.duration * mode_resources.consumption_per_minute) AS total_consumption, resources.measure_unit FROM `production.batches.stages.machines` JOIN `production.batches.stages` ON `production.batches.stages`.id = `production.batches.stages.machines`.stage_id JOIN mode_resources ON mode_resources.mode_id = `production.batches.stages.machines`.mode_id JOIN resources ON resources.id = mode_resources.resource_id WHERE `production.batches.stages`.batch_id = {manufacture_id_factory} GROUP BY resources.id, resources.name, resources.measure_unit; 